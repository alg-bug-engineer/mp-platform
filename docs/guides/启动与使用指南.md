# 启动与使用指南（Content Studio）

本文用于快速完成本项目的启动、初始化和业务使用。

## 1. 环境要求

- Python 3.10+（建议直接使用 `python3.10`）
- Node.js 18+
- Docker / Docker Compose（容器化部署时）

## 2. 方式一：本地启动（开发/调试）

### 2.1 安装依赖

```bash
pip install -r requirements.txt
cd web_ui
npm install
cd ..
```

如果你的默认 Python 版本低于 3.10，请改用：

```bash
python3.10 -m pip install -r requirements.txt
```

### 2.2 初始化配置与数据库

```bash
cp config.example.yaml config.yaml
python init_sys.py
```

### 2.3 构建前端并同步静态文件

```bash
cd web_ui
npm run build
cd ..
rsync -a --delete web_ui/dist/ static/
```

### 2.4 启动服务

```bash
python3.10 main.py -job True -init False
```

访问地址：
- `http://127.0.0.1:8001`

默认管理员（首次初始化）：
- 用户名：`admin`
- 密码：`admin@123`

## 3. 方式二：Docker + PostgreSQL（推荐）

```bash
cd compose
docker compose -f docker-compose-postgresql.yaml up -d --build
```

访问地址：
- `http://127.0.0.1:8001`

停止服务：

```bash
docker compose -f docker-compose-postgresql.yaml down
```

## 4. 首次使用流程

### 4.1 注册与登录

1. 进入登录页
2. 切到“注册”页签
3. 输入手机号、密码完成注册
4. 使用手机号+密码登录

### 4.2 AI 配置

进入 `AI 创作` 页面，填写并保存：

- `Base URL`：OpenAI 兼容接口地址（示例：`https://api.moonshot.cn/v1`）
- `Model`：模型名（示例：`kimi-k2-0711-preview`）
- `API Key`：模型服务密钥

### 4.3 订阅与创作

1. 进入 `订阅管理`
2. 在 `已添加账号` 区域确认账号是否存在
3. 可在 `推荐账号` 点击一键检索，或使用文章链接自动识别公众号
4. 回到 `AI 创作`
5. 点击文章标题可打开全文页（正文为空时会自动尝试抓取）
6. 点击 `分析` / `创作` / `仿写`，创作时会弹出平台/风格/篇幅/图片张数等选项
7. 在创作结果弹窗中点击 `发布到草稿箱`，可保存本地草稿，或一键尝试同步到公众号草稿箱
8. 若公众号同步失败，可在 `创作中台 -> 草稿投递队列` 手动重试或批量处理

### 4.4 套餐能力与配额

系统内置三档能力（可按业务策略调整）：

- 免费用户：基础创作 + 本地草稿箱，低配额
- 付费用户：高配额 + 即梦生图 + 公众号草稿投递
- 高级用户：更高配额，适合团队化运营

配额默认按月重置，创作中台会显示：
- AI 配额已用/剩余
- 图片配额已用/剩余
- 当前套餐是否支持公众号草稿投递

管理员可进入 `套餐管理` 页面，调整用户档位与配额。

### 4.5 支付订阅闭环（推荐验收路径）

1. 登录普通用户，进入 `支付订阅` 页面（`/billing`）
2. 选择套餐（`pro` 或 `premium`）并创建订单
3. 点击 `确认支付`（mock 通道）
4. 观察“当前套餐状态”已切换，`plan_expires_at` 生效
5. 回到 `创作中台` 验证能力变化（生图/草稿投递权限）
6. 管理员可在 `支付订阅` 页面查看全局订单并执行到期扫描（管理员可见）

### 4.6 AI 本地规则配置（不依赖大模型做标签推荐）

默认规则文件：`data/ai_local_rules.yaml`

可自定义：
- `tag_rules`：标题关键词到标签映射
- `platform_templates`：公众号/小红书/知乎/推特的写作结构与约束
- `ai_style_guard`：禁用模板化词语

配置项位于 `config.yaml`：

```yaml
ai:
  local_rules_file: ./data/ai_local_rules.yaml
  refine_enabled: true
  draft_dir: ./data/ai_drafts
  publish_queue_interval_seconds: 45
```

### 4.7 即梦能力调试脚本（封面/Logo/素材）

脚本：`tests/test_jimeng_api.py`

使用前设置：

```bash
export JIMENG_AK='your-ak'
export JIMENG_SK='your-sk'
```

示例：

```bash
python tests/test_jimeng_api.py --scene article_cover --topic "自媒体增长" --style "极简商业"
python tests/test_jimeng_api.py --scene logo --topic "Content Studio" --style "科技感"
```

## 5. 多用户隔离说明

本系统按用户隔离数据（账号维度）：

- 公众号
- 文章
- 标签
- 消息任务
- AI 配置

不同用户互不可见。

## 6. 历史文件清理

可执行脚本：

```bash
./script/clean_history.sh
```

功能：
- 重新构建前端
- 用最新 `web_ui/dist` 同步覆盖 `static`（自动删除历史 hash 文件）
- 清理 Python 缓存文件（`*.pyc` / 空 `__pycache__`）

若你只想清理而不重新构建：

```bash
./script/clean_history.sh --skip-build
```

## 7. 常见问题

### 7.1 登录接口调试失败

`/api/v1/wx/auth/login` 使用 `application/x-www-form-urlencoded`，不是 JSON。

### 7.2 Docker 启动后访问失败

先检查容器状态：

```bash
docker compose -f compose/docker-compose-postgresql.yaml ps
```

### 7.3 页面还是旧版静态资源

执行：

```bash
./script/clean_history.sh
```

并清理浏览器缓存后重试。

### 7.4 点击文章看不到全文

可能原因：
- 该文章尚未抓取正文
- 公众号授权失效导致抓取失败
- 原文已删除或不可访问

处理方式：
- 在文章弹窗点击 `抓取全文`
- 或进入详情页后通过 `?auto_fetch=1` 自动尝试抓取

### 7.5 扫码授权失败或二维码一直无法显示

若弹窗提示获取二维码失败，通常是服务端缺少浏览器依赖（Playwright runtime）：

1. 检查 `server.auth_web` 是否开启（`config.yaml`）
2. 若开启，请在运行环境安装对应浏览器依赖
3. 或改用 API 登录方式（关闭 `auth_web`）进行授权

当前版本已支持失败态快速中止轮询，不会无限等待。
