# ğŸš€ å¯åŠ¨æ–¹å¼è¯´æ˜

## âš ï¸ é‡è¦è¯´æ˜

**ä¹‹å‰æ–‡æ¡£ä¸­çš„å¯åŠ¨æ–¹å¼ä¸æ­£ç¡®ï¼Œå·²æ›´æ–°ï¼**

- âŒ é”™è¯¯ï¼š`python web.py`
- âœ… æ­£ç¡®ï¼š`python main.py -job True -init True`

---

## ğŸ“Š å¯åŠ¨æ–¹å¼å¯¹æ¯”

### `main.py` vs `web.py`

| ç‰¹æ€§ | `main.py` | `web.py` |
|------|-----------|----------|
| **ä½œç”¨** | åº”ç”¨å¯åŠ¨å…¥å£ | FastAPI åº”ç”¨å®šä¹‰ |
| **å®šæ—¶ä»»åŠ¡** | âœ… æ”¯æŒï¼ˆ`-job True`ï¼‰ | âŒ ä¸æ”¯æŒ |
| **ç³»ç»Ÿåˆå§‹åŒ–** | âœ… æ”¯æŒï¼ˆ`-init True`ï¼‰ | âŒ ä¸æ”¯æŒ |
| **é…ç½®è¯»å–** | âœ… è¯»å– `config.yaml` | âŒ æ— é…ç½® |
| **ç”Ÿäº§ç¯å¢ƒ** | âœ… é€‚åˆ | âŒ ä¸é€‚åˆ |
| **å¼€å‘ç¯å¢ƒ** | âœ… é€‚åˆï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰ | âŒ åŠŸèƒ½ä¸å®Œæ•´ |

### ä»£ç åˆ†æ

**`main.py`ï¼ˆç¬¬22è¡Œï¼‰ï¼š**
```python
uvicorn.run("web:app",  # è¿è¡Œçš„æ˜¯ web.py ä¸­çš„ app
           host="0.0.0.0",
           port=int(cfg.get("port", 8001)),
           reload=AutoReload,
           workers=thread)
```

**`web.py`ï¼š**
- åªå®šä¹‰äº† FastAPI åº”ç”¨å®ä¾‹
- å¯¼å‡ºäº† `app` å¯¹è±¡ä¾› `main.py` ä½¿ç”¨
- ä¸åŒ…å«å¯åŠ¨é€»è¾‘

---

## âœ… æ­£ç¡®çš„å¯åŠ¨æ–¹å¼

### 1ï¸âƒ£ å¼€å‘ç¯å¢ƒï¼ˆæ¨èç”¨äºæœ¬åœ°å¼€å‘ï¼‰

#### åç«¯å¯åŠ¨
```bash
python main.py -job True -init True
```

**å‚æ•°è¯´æ˜ï¼š**
- `-job True`ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆæ–‡ç« åŒæ­¥ã€æŠ•é€’é˜Ÿåˆ—å¤„ç†ç­‰ï¼‰
- `-init True`ï¼šåˆå§‹åŒ–ç³»ç»Ÿï¼ˆåˆ›å»ºæ•°æ®åº“è¡¨ã€é»˜è®¤é…ç½®ç­‰ï¼‰

**ç‰¹æ€§ï¼š**
- âœ… æ”¯æŒä»£ç çƒ­é‡è½½ï¼ˆä¿®æ”¹ä»£ç è‡ªåŠ¨é‡å¯ï¼‰
- âœ… å¯ç”¨å®šæ—¶ä»»åŠ¡
- âœ… ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ–
- âœ… è¯»å– `config.yaml` é…ç½®

#### å‰ç«¯å¯åŠ¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
```bash
cd web_ui && npm run dev
```

**è®¿é—®åœ°å€ï¼š**
- å‰ç«¯ï¼šhttp://localhost:5173
- åç«¯ APIï¼šhttp://localhost:8001
- API æ–‡æ¡£ï¼šhttp://localhost:8001/docs

---

### 2ï¸âƒ£ ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èç”¨äºæœåŠ¡å™¨éƒ¨ç½²ï¼‰

#### ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# ä¸€é”®å¯åŠ¨ï¼ˆè‡ªåŠ¨å®‰è£…ä¾èµ–ã€æ„å»ºå‰ç«¯ã€åå°è¿è¡Œï¼‰
script/deploy.sh start

# é‡å¯æœåŠ¡
script/deploy.sh restart

# æŸ¥çœ‹çŠ¶æ€
script/deploy.sh status

# åœæ­¢æœåŠ¡
script/deploy.sh stop

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/content-studio.log
```

**éƒ¨ç½²è„šæœ¬çš„åŠŸèƒ½ï¼š**
1. å®‰è£…åç«¯ä¾èµ–ï¼ˆ`pip install -r requirements.txt`ï¼‰
2. å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆ`npm install`ï¼‰
3. æ„å»ºå‰ç«¯ï¼ˆ`npm run build`ï¼‰
4. åŒæ­¥å‰ç«¯åˆ° `static/` ç›®å½•
5. åå°è¿è¡ŒæœåŠ¡ï¼ˆ`nohup python main.py ...`ï¼‰
6. ç®¡ç† PID æ–‡ä»¶å’Œæ—¥å¿—

**è®¿é—®åœ°å€ï¼š**
- å‰ç«¯+åç«¯ï¼šhttp://localhost:8001
- API æ–‡æ¡£ï¼šhttp://localhost:8001/docs

#### æ‰‹åŠ¨å¯åŠ¨ï¼ˆä¸æ¨èï¼‰
```bash
# ä»…å½“éƒ¨ç½²è„šæœ¬ä¸å¯ç”¨æ—¶ä½¿ç”¨
nohup python main.py -job True -init False > logs/app.log 2>&1 &
```

**å‚æ•°è¯´æ˜ï¼š**
- `-job True`ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡
- `-init False`ï¼šè·³è¿‡åˆå§‹åŒ–ï¼ˆé¦–æ¬¡å¯åŠ¨ç”¨ Trueï¼Œåç»­ç”¨ Falseï¼‰

---

## ğŸ”§ å¯åŠ¨æµç¨‹è¯¦è§£

### å¼€å‘ç¯å¢ƒå¯åŠ¨æµç¨‹

```
1. ç”¨æˆ·æ‰§è¡Œ: python main.py -job True -init True
   â†“
2. main.py æ£€æŸ¥å‚æ•°
   â†“
3. init=True â†’ æ‰§è¡Œ init_sys.pyï¼ˆåˆ›å»ºæ•°æ®åº“è¡¨ï¼‰
   â†“
4. job=True â†’ å¯åŠ¨å®šæ—¶ä»»åŠ¡çº¿ç¨‹
   â†“
5. uvicorn.run("web:app") â†’ å¯åŠ¨ FastAPI åº”ç”¨
   â†“
6. ç›‘å¬ 0.0.0.0:8001ï¼ˆç«¯å£æ¥è‡ª config.yamlï¼‰
   â†“
7. æ”¯æŒä»£ç çƒ­é‡è½½ï¼ˆreload=Trueï¼‰
```

### ç”Ÿäº§ç¯å¢ƒå¯åŠ¨æµç¨‹

```
1. ç”¨æˆ·æ‰§è¡Œ: script/deploy.sh start
   â†“
2. å®‰è£…åç«¯ä¾èµ–ï¼ˆpip installï¼‰
   â†“
3. å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆnpm installï¼‰
   â†“
4. æ„å»ºå‰ç«¯ï¼ˆnpm run buildï¼‰
   â†“
5. åŒæ­¥ web_ui/dist/ â†’ static/
   â†“
6. å¯åŠ¨åç«¯: nohup python main.py -job True -init False &
   â†“
7. ä¿å­˜ PID åˆ° run/content-studio.pid
   â†“
8. æ—¥å¿—è¾“å‡ºåˆ° logs/content-studio.log
   â†“
9. å‰ç«¯é™æ€æ–‡ä»¶ç”± FastAPI æä¾›ï¼ˆ/staticï¼‰
```

---

## ğŸ†š å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒç‰¹ç‚¹
- å‰ç«¯å’Œåç«¯**åˆ†ç¦»è¿è¡Œ**
- å‰ç«¯ä½¿ç”¨ Vite å¼€å‘æœåŠ¡å™¨ï¼ˆhttp://localhost:5173ï¼‰
- åç«¯ä½¿ç”¨ Uvicornï¼ˆhttp://localhost:8001ï¼‰
- æ”¯æŒ**çƒ­é‡è½½**ï¼Œä¿®æ”¹ä»£ç è‡ªåŠ¨ç”Ÿæ•ˆ
- å‰ç«¯ä»£ç†åç«¯ API è¯·æ±‚ï¼ˆ`vite.config.ts` ä¸­é…ç½®ï¼‰

### ç”Ÿäº§ç¯å¢ƒç‰¹ç‚¹
- å‰ç«¯å’Œåç«¯**ç»Ÿä¸€è¿è¡Œ**
- å‰ç«¯å·²æ„å»ºä¸ºé™æ€æ–‡ä»¶ï¼ˆ`static/`ï¼‰
- åç«¯åŒæ—¶æä¾› API å’Œé™æ€æ–‡ä»¶æœåŠ¡
- ä½¿ç”¨ `nohup` åå°è¿è¡Œ
- ç®¡ç† PID å’Œæ—¥å¿—æ–‡ä»¶

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. ä¸ºä»€ä¹ˆç›´æ¥è¿è¡Œ `python web.py` ä¸è¡Œï¼Ÿ
**åŸå› ï¼š** `web.py` åªå®šä¹‰äº† FastAPI åº”ç”¨ï¼Œä¸åŒ…å«å¯åŠ¨é€»è¾‘ã€‚

**è§£å†³ï¼š** ä½¿ç”¨ `python main.py` å¯åŠ¨ã€‚

---

### 2. é¦–æ¬¡å¯åŠ¨åº”è¯¥ç”¨ä»€ä¹ˆå‚æ•°ï¼Ÿ
**ç­”æ¡ˆï¼š**
```bash
# å¼€å‘ç¯å¢ƒé¦–æ¬¡å¯åŠ¨
python main.py -job True -init True

# ç”Ÿäº§ç¯å¢ƒé¦–æ¬¡å¯åŠ¨
script/deploy.sh start  # éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†
```

**è¯´æ˜ï¼š** `-init True` ä¼šåˆå§‹åŒ–æ•°æ®åº“å’Œç³»ç»Ÿé…ç½®ï¼Œé¦–æ¬¡å¯åŠ¨å¿…é¡»ä½¿ç”¨ã€‚

---

### 3. åç»­å¯åŠ¨å¯ä»¥è·³è¿‡åˆå§‹åŒ–å—ï¼Ÿ
**ç­”æ¡ˆï¼š** å¯ä»¥ï¼Œä½¿ç”¨ `-init False`
```bash
python main.py -job True -init False
```

**å»ºè®®ï¼š** å¼€å‘ç¯å¢ƒä¿æŒ `-init True`ï¼ˆåˆå§‹åŒ–é€»è¾‘æœ‰å¹‚ç­‰æ€§ï¼Œé‡å¤æ‰§è¡Œæ— å½±å“ï¼‰ã€‚

---

### 4. å¦‚ä½•å…³é—­å®šæ—¶ä»»åŠ¡ï¼Ÿ
**ç­”æ¡ˆï¼š** ä½¿ç”¨ `-job False`
```bash
python main.py -job False -init True
```

**åœºæ™¯ï¼š** è°ƒè¯• API æ—¶ä¸éœ€è¦å®šæ—¶ä»»åŠ¡å¯ä»¥å…³é—­ã€‚

---

### 5. éƒ¨ç½²è„šæœ¬åœ¨å“ªé‡Œé…ç½®ç¯å¢ƒå˜é‡ï¼Ÿ
**ç­”æ¡ˆï¼š** åˆ›å»º `.env.deploy` æ–‡ä»¶
```bash
# .env.deploy
JIMENG_AK=your_access_key
JIMENG_SK=your_secret_key
WECHAT_WHITELIST_IPS=1.2.3.4,5.6.7.8
```

**ä½¿ç”¨ï¼š**
```bash
script/deploy.sh start --env-file .env.deploy
```

---

### 6. å¦‚ä½•æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ï¼Ÿ
**ç­”æ¡ˆï¼š**
```bash
# å®æ—¶æŸ¥çœ‹
tail -f logs/content-studio.log

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
tail -n 100 logs/content-studio.log

# æœç´¢é”™è¯¯
grep -i error logs/content-studio.log
```

---

### 7. å‰ç«¯å¼€å‘æ—¶å¦‚ä½•è°ƒç”¨åç«¯ APIï¼Ÿ
**ç­”æ¡ˆï¼š** Vite å¼€å‘æœåŠ¡å™¨å·²é…ç½®ä»£ç†

**`web_ui/vite.config.ts`ï¼š**
```typescript
server: {
  proxy: {
    '/api': 'http://localhost:8001'  // ä»£ç†åˆ°åç«¯
  }
}
```

**å‰ç«¯è¯·æ±‚ï¼š**
```typescript
// å¼€å‘ç¯å¢ƒï¼šhttp://localhost:5173/api/ai/compose/options
//   â†“ ä»£ç†åˆ°
// åç«¯ï¼šhttp://localhost:8001/api/ai/compose/options

await fetch('/api/ai/compose/options')
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### æ—¥å¸¸å¼€å‘å¯åŠ¨
```bash
# ç»ˆç«¯ 1ï¼šåç«¯
python main.py -job True -init True

# ç»ˆç«¯ 2ï¼šå‰ç«¯
cd web_ui && npm run dev

# è®¿é—®: http://localhost:5173
```

### ç”Ÿäº§éƒ¨ç½²å¯åŠ¨
```bash
# ä¸€é”®å¯åŠ¨
script/deploy.sh start

# æŸ¥çœ‹çŠ¶æ€
script/deploy.sh status

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/content-studio.log

# è®¿é—®: http://localhost:8001
```

### éªŒè¯ä¼˜åŒ–åŠŸèƒ½
```bash
# è¿è¡ŒéªŒè¯è„šæœ¬
python tests/manual/verify_optimization.py

# æ‰€æœ‰æ¨¡å—åº”æ˜¾ç¤º âœ… é€šè¿‡
```

---

## ğŸ¯ æ€»ç»“

| åœºæ™¯ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| **å¼€å‘ - åç«¯** | `python main.py -job True -init True` | å¸¦çƒ­é‡è½½å’Œå®šæ—¶ä»»åŠ¡ |
| **å¼€å‘ - å‰ç«¯** | `cd web_ui && npm run dev` | Vite å¼€å‘æœåŠ¡å™¨ |
| **ç”Ÿäº§ - å¯åŠ¨** | `script/deploy.sh start` | è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½² |
| **ç”Ÿäº§ - é‡å¯** | `script/deploy.sh restart` | é‡å¯æœåŠ¡ |
| **ç”Ÿäº§ - åœæ­¢** | `script/deploy.sh stop` | åœæ­¢æœåŠ¡ |
| **æŸ¥çœ‹çŠ¶æ€** | `script/deploy.sh status` | æ£€æŸ¥è¿è¡ŒçŠ¶æ€ |
| **æŸ¥çœ‹æ—¥å¿—** | `tail -f logs/content-studio.log` | å®æ—¶æ—¥å¿— |

---

**âœ… å·²æ›´æ­£æ‰€æœ‰æ–‡æ¡£ä¸­çš„å¯åŠ¨æ–¹å¼ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„ `main.py` å¯åŠ¨ï¼**
